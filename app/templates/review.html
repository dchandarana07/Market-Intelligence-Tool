{% extends "base.html" %}

{% block title %}Review & Run · Market Intelligence{% endblock %}

{% block progress %}
<section class="progress-shell">
    <div class="container">
        <ol class="progress-rail">
            <li class="progress-node completed"><span class="node-index">1</span><div><strong>Start</strong></div></li>
            <li class="progress-node completed"><span class="node-index">2</span><div><strong>Modules</strong></div></li>
            <li class="progress-node completed"><span class="node-index">3</span><div><strong>Configure</strong></div></li>
            <li class="progress-node active"><span class="node-index">4</span><div><strong>Review</strong></div></li>
            <li class="progress-node"><span class="node-index">5</span><div><strong>Run</strong></div></li>
        </ol>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="page-header">
    <span class="eyebrow">Final checkpoint</span>
    <h1>Review configuration</h1>
    <p class="hero-lede">Give everything one last glance before we orchestrate the run.</p>
</div>

<div class="summary-grid">
    <div class="summary-tile">
        <span>Topic</span>
        <strong>{{ session.topic }}</strong>
    </div>
    <div class="summary-tile">
        <span>Delivery</span>
        <strong>{{ session.email }}</strong>
    </div>
</div>

<div class="panel" style="margin-top:32px;">
    <h2 style="margin-top:0;">Module blueprint</h2>
    <div class="timeline">
        {% for module_info in modules_info %}
        <div class="timeline-item">
            <div class="timeline-icon">{{ loop.index }}</div>
            <div style="flex:1;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">{{ module_info.display_name }}</h3>
                    <a href="/module/{{ module_info.name }}" class="link-soft">Edit</a>
                </div>
                <div class="summary-grid" style="margin-top:16px;">
                    {% for key, value in module_info.inputs.items() %}
                    {% if value %}
                    <div class="summary-tile">
                        <span>{{ key.replace('_', ' ').title() }}</span>
                        <strong>
                            {% if value is iterable and value is not string %}
                                {{ value | join(', ') }}
                            {% elif value == True %}
                                Yes
                            {% elif value == False %}
                                No
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </strong>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<form action="/run" method="POST" class="panel form-card" style="margin-top:32px;">
    <h2 style="margin-top:0;">Sharing controls</h2>
    <div class="module-list">
        <label class="module-card">
            <input type="radio" name="sharing_mode" value="restricted" checked>
            <div class="module-meta">
                <h3>Restricted (recommended)</h3>
                <p>Only {{ session.email }} can access the Google Sheet.</p>
            </div>
        </label>
        <label class="module-card">
            <input type="radio" name="sharing_mode" value="anyone">
            <div class="module-meta">
                <h3>Anyone with the link</h3>
                <p class="module-note">Less secure. Anyone with the URL can view.</p>
            </div>
        </label>
    </div>

    <div class="actions" style="justify-content:space-between;">
        <a href="/module/{{ modules_info[-1].name }}" class="btn btn-ghost">Back to last module</a>
        <button type="submit" class="btn btn-primary">
            Run intelligence workflow
        </button>
    </div>
</form>

<div class="callout" style="margin-top:24px;">
    <strong>Runtime:</strong> Expect 2–5 minutes depending on modules. Feel free to navigate away—results auto-email to {{ session.email }}.
</div>
{% endblock %}
