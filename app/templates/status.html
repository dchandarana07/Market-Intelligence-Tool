{% extends "base.html" %}

{% block title %}Running Analysis Â· Market Intelligence{% endblock %}

{% block progress %}
<section class="progress-shell">
    <div class="container">
        <ol class="progress-rail">
            <li class="progress-node completed"><span class="node-index">1</span><div><strong>Start</strong></div></li>
            <li class="progress-node completed"><span class="node-index">2</span><div><strong>Modules</strong></div></li>
            <li class="progress-node completed"><span class="node-index">3</span><div><strong>Configure</strong></div></li>
            <li class="progress-node completed"><span class="node-index">4</span><div><strong>Review</strong></div></li>
            <li class="progress-node active"><span class="node-index">5</span><div><strong>Run</strong></div></li>
        </ol>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="page-header">
    <span class="eyebrow">Live execution</span>
    <h1>Running analysis</h1>
    <p class="hero-lede">{{ run_info.session.topic }}</p>
</div>

<div class="panel fade-in">
    <div id="overall-status" class="results-card">
        <div class="loading-spinner" style="margin-bottom:18px;"></div>
        <div id="status-text">Starting analysis...</div>
    </div>

    <div id="module-progress" class="status-list" style="margin-top:32px;">
        {% for module_name in run_info.session.selected_modules %}
        <div id="module-{{ module_name }}" class="status-row">
            <div>
                <div id="name-{{ module_name }}"><strong>{{ module_name | title }}</strong></div>
                <div id="message-{{ module_name }}" class="input-hint">Waiting...</div>
            </div>
            <div id="icon-{{ module_name }}" class="pill">Queued</div>
        </div>
        {% endfor %}
    </div>

    <div id="error-display" class="alert error hidden" style="margin-top:24px;">
        <strong>Errors detected:</strong>
        <ul id="error-list" style="margin:10px 0 0 18px; padding:0;"></ul>
    </div>

    <div id="results-section" class="hidden" style="margin-top:32px;">
        <div class="results-card">
            <div class="icon-ring">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2">
                    <path d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2>Analysis complete</h2>
            <p class="input-hint">Your results are ready in Google Sheets.</p>
            <a id="results-link" href="#" target="_blank" class="btn btn-primary" style="margin-top:20px;">
                Open results
            </a>
            <p class="input-hint" style="margin-top:16px;">A link has also been sent to {{ run_info.session.email }}.</p>
        </div>
    </div>

    <div id="new-analysis" class="hidden" style="margin-top:24px;text-align:center;">
        <a href="/" class="link-soft">Start a new analysis</a>
    </div>
</div>

<script>
    const runId = "{{ run_id }}";

    document.addEventListener('DOMContentLoaded', function() {
        startExecution();
    });

    async function startExecution() {
        try {
            const response = await fetch(`/execute/${runId}`, { method: 'POST' });
            const result = await response.json();

            if (result.error) {
                showError([result.error]);
                return;
            }

            updateStatus(result);
        } catch (error) {
            console.error('Execution failed:', error);
            showError(['Failed to start analysis. Please try again.']);
        }
    }

    function updateStatus(result) {
        const overallStatus = document.getElementById('overall-status');
        const statusText = document.getElementById('status-text');
        const resultsSection = document.getElementById('results-section');
        const newAnalysis = document.getElementById('new-analysis');

        if (result.modules) {
            for (const [moduleName, moduleInfo] of Object.entries(result.modules)) {
                updateModuleStatus(moduleName, moduleInfo);
            }
        }

        if (result.status === 'completed' || result.status === 'partial') {
            overallStatus.innerHTML = `
                <div class="icon-ring" style="margin-bottom:16px;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2">
                        <path d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="hero-lede" style="font-size:1.2rem;">${result.status === 'completed' ? 'Analysis complete' : 'Complete with warnings'}</div>
            `;

            if (result.output_url) {
                document.getElementById('results-link').href = result.output_url;
                resultsSection.classList.remove('hidden');
            }

            newAnalysis.classList.remove('hidden');
        } else if (result.status === 'failed') {
            overallStatus.innerHTML = `
                <div class="icon-ring" style="border-color:rgba(251,113,133,0.4);background:rgba(251,113,133,0.12);margin-bottom:16px;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fb7185" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div class="hero-lede" style="font-size:1.2rem;">Analysis failed</div>
            `;

            if (result.errors && result.errors.length > 0) {
                showError(result.errors);
            }

            newAnalysis.classList.remove('hidden');
        } else {
            statusText.textContent = result.status || 'Running...';
        }
    }

    function updateModuleStatus(moduleName, moduleInfo) {
        const moduleDiv = document.getElementById(`module-${moduleName}`);
        const iconDiv = document.getElementById(`icon-${moduleName}`);
        const nameDiv = document.getElementById(`name-${moduleName}`);
        const messageDiv = document.getElementById(`message-${moduleName}`);

        if (!moduleDiv) return;

        nameDiv.innerHTML = `<strong>${moduleInfo.display_name || moduleName}</strong>`;
        messageDiv.textContent = moduleInfo.message || moduleInfo.status;

        switch (moduleInfo.status) {
            case 'running':
                iconDiv.innerHTML = '<div class="loading-spinner" style="width:18px;height:18px;"></div>';
                iconDiv.className = 'pill';
                moduleDiv.className = 'status-row running';
                break;
            case 'completed':
                iconDiv.textContent = 'Complete';
                iconDiv.className = 'pill success';
                moduleDiv.className = 'status-row completed';
                break;
            case 'partial':
                iconDiv.textContent = 'Partial';
                iconDiv.className = 'pill warning';
                moduleDiv.className = 'status-row';
                break;
            case 'failed':
                iconDiv.textContent = 'Failed';
                iconDiv.className = 'pill danger';
                moduleDiv.className = 'status-row failed';
                break;
            default:
                iconDiv.textContent = 'Queued';
                iconDiv.className = 'pill';
                moduleDiv.className = 'status-row';
        }
    }

    function showError(errors) {
        const errorDisplay = document.getElementById('error-display');
        const errorList = document.getElementById('error-list');

        errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
        errorDisplay.classList.remove('hidden');
    }
</script>
{% endblock %}
